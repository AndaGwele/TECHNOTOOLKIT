<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>CVision – Resume Optimizer</title>
        <style>
        /* Hub Matching Styles */
        /* * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        } */

        body {
            background: #f8f9fa;
            color: #333;
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .navbar {
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .nav-brand h1 {
            margin: 0;
            text-align: center;
            color: #333;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 15px 0 0 0;
            justify-content: center;
            gap: 20px;
        }

        .nav-menu li {
            margin: 0;
        }

        .nav-link {
            text-decoration: none;
            color: #333;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-link:hover {
            background-color: #f8f9fa;
        }

        .nav-link.active {
            font-weight: bold;
            color: #007bff;
        }

        /* User Info Bar */
        .user-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }

        .user-details {
            font-size: 14px;
            color: #666;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        /* Cards */
        .form-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-header h2, .card-header h3 {
            margin: 0;
            color: #333;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        input[type="file"],
        textarea,
        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        /* Messages */
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .empty-state {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #333;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* Feedback Styles */
        .feedback-strength { 
            color: #28a745; 
            font-weight: 500;
            padding: 8px;
            background: #f8fff9;
            border-left: 4px solid #28a745;
            margin: 5px 0;
        }
        
        .feedback-weakness { 
            color: #dc3545; 
            font-weight: 500;
            padding: 8px;
            background: #fff8f8;
            border-left: 4px solid #dc3545;
            margin: 5px 0;
        }
        
        .feedback-improvement { 
            color: #007bff; 
            font-weight: 500;
            padding: 8px;
            background: #f8fbff;
            border-left: 4px solid #007bff;
            margin: 5px 0;
        }

        .match-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-top: 15px;
        }

        .success-text {
            color: #28a745;
            font-weight: 500;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #f8fff9;
            border-radius: 4px;
            border: 1px solid #d4edda;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .nav-menu {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>
    </head>
    <body>

        <div class="container">
            <!-- User Info Bar (if needed) -->
            <!-- <div class="user-info">
                <div class="user-details">
                    <strong>Welcome, User</strong>
                </div>
                <a href="?logout=true" class="logout-btn">Logout</a>
            </div> -->

            <!-- Success Message Area -->
            <div id="message-area"></div>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Analysis Section -->
                <section id="analysis" class="section active">
                    <div class="form-card">
                        <div class="card-header">
                            <h2>Resume Analysis</h2>
                        </div>

                        <div class="form-group">
                            <label for="document-upload">Upload Your Resume
                                (PDF):</label>
                            <input type="file" id="document-upload"
                                accept=".pdf" />
                        </div>

                        <div class="form-group">
                            <label for="job-description">Job
                                Description:</label>
                            <textarea
                                id="job-description"
                                placeholder="Paste the job description here..."
                                rows="6"></textarea>
                        </div>

                        <button type="button" class="btn btn-primary"
                            id="analyze-btn">
                            Analyze Resume
                        </button>
                    </div>

                    <div id="loading" class="loading" style="display: none;">
                        <p>Processing your resume and analyzing against job
                            description...</p>
                    </div>

                    <!-- AI Feedback Results -->
                    <div id="ai-feedback" class="result-card"
                        style="display: none;">
                        <div class="card-header">
                            <h3>AI Analysis & Recommendations</h3>
                        </div>
                        <div id="feedback-content"></div>
                    </div>

                    <!-- Fallback Keyword Match -->
                    <div id="match-result" class="result-card"
                        style="display: none;">
                        <div class="card-header">
                            <h3>Basic Keyword Analysis</h3>
                        </div>
                        <div class="match-result">
                            <p><strong>AI unavailable. Showing basic keyword
                                    match analysis.</strong></p>
                            <p><strong>Match Percentage:</strong> <span
                                    id="match-percentage"></span>%</p>
                            <p><strong>Missing Keywords:</strong> <span
                                    id="missing-keywords"></span></p>
                        </div>
                    </div>

                    <div id="success-text" class="success-text"
                        style="display: none;">
                        ✅ Resume text successfully extracted and ready for
                        analysis
                    </div>
                </section>
            </main>
        </div>

        <script>
        // API Configuration
        const API_KEY = "AIzaSyDhdk2VpT0T2l_f0ZXNAEr0_Wf5WYYc6d0";
        let pdfjsLib = null;

        // Load pdf.js dynamically
        const script = document.createElement("script");
        script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js";
        script.onload = () => {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc =
                "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
            pdfjsLib = window.pdfjsLib;
            console.log("✅ pdf.js loaded");
        };
        document.head.appendChild(script);

        // DOM Elements
        const documentUpload = document.getElementById('document-upload');
        const jobDescription = document.getElementById('job-description');
        const analyzeBtn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        const aiFeedback = document.getElementById('ai-feedback');
        const feedbackContent = document.getElementById('feedback-content');
        const matchResult = document.getElementById('match-result');
        const matchPercentage = document.getElementById('match-percentage');
        const missingKeywords = document.getElementById('missing-keywords');
        const successText = document.getElementById('success-text');
        const messageArea = document.getElementById('message-area');

        // State variables
        let cvText = "";

        // Event Listeners
        documentUpload.addEventListener('change', handleFileUpload);
        analyzeBtn.addEventListener('click', handleAnalyze);

        // Functions
        async function handleFileUpload(event) {
            if (!pdfjsLib) {
                showMessage("PDF.js is still loading. Please wait.", "error");
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== "application/pdf") {
                showMessage("Please upload a PDF file only.", "error");
                return;
            }

            setLoading(true);
            hideResults();
            
            try {
                const fileReader = new FileReader();
                fileReader.onload = async function () {
                    const typedArray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedArray).promise;

                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map((item) => item.str).join(" ");
                        fullText += pageText + "\n";
                    }

                    cvText = fullText;
                    setLoading(false);
                    showSuccessText();
                    showMessage("Resume uploaded successfully!", "success");
                };
                fileReader.readAsArrayBuffer(file);
            } catch (err) {
                console.error(err);
                showMessage("Failed to extract text from PDF.", "error");
                setLoading(false);
            }
        }

        function preprocessText(text) {
            const stopwords = [
                "a","an","the","and","or","but","if","then","else","for","of","on","in","with",
                "to","from","by","as","at","be","is","are","was","were","this","that","these",
                "those","such","it","its","i","you","he","she","they","we"
            ];
            return text
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, "")
                .split(/\s+/)
                .filter(Boolean)
                .filter((word) => !stopwords.includes(word));
        }

        function computeKeywordMatch(cv, job) {
            const cvWords = preprocessText(cv);
            const jobWords = preprocessText(job);
            const jobWordSet = Array.from(new Set(jobWords));

            const foundKeywords = [];
            const missingKeywords = [];

            jobWordSet.forEach((word) => {
                if (cvWords.includes(word)) foundKeywords.push(word);
                else missingKeywords.push(word);
            });

            const matchPercentage = Math.round(
                (foundKeywords.length / jobWordSet.length) * 100
            );

            return { matchPercentage, missingKeywords, foundKeywords };
        }

        async function handleAnalyze() {
            if (!cvText) {
                showMessage("Please upload a resume first.", "error");
                return;
            }
            
            if (!jobDescription.value.trim()) {
                showMessage("Please enter a job description.", "error");
                return;
            }

            setLoading(true);
            hideResults();
            hideSuccessText();

            const prompt = `
You are an expert resume optimizer and ATS system.
Given the CV text and job description below, provide a concise, structured analysis:

1. Strengths: top skills/keywords the CV matches (label as **STRENGTHS**)
2. Weaknesses: missing important skills/keywords (label as **WEAKNESSES**)
3. Improvements: 2–3 actionable steps to increase ATS compatibility (label as **IMPROVEMENTS**)
4. Summarize whether this CV is a strong, moderate, or weak match overall (label as **MATCH SCORE**)

CV TEXT:
${cvText}

JOB DESCRIPTION:
${jobDescription.value}
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const data = await response.json();
                const feedback = data.candidates[0].content.parts[0].text;
                showAiFeedback(feedback);
                showMessage("Analysis completed successfully!", "success");
            } catch (err) {
                console.error("Gemini API failed:", err);
                const localMatch = computeKeywordMatch(cvText, jobDescription.value);
                showMatchResult(localMatch);
                showMessage("Using basic keyword analysis (AI unavailable)", "warning");
            } finally {
                setLoading(false);
            }
        }

        function renderAiFeedback(feedback) {
            if (!feedback) return '<p class="empty-state">No feedback generated.</p>';
            const lines = feedback.split("\n");
            return lines.map((line, idx) => {
                if (line.toUpperCase().includes("STRENGTH")) return `<p class="feedback-strength">${line}</p>`;
                if (line.toUpperCase().includes("WEAKNESS")) return `<p class="feedback-weakness">${line}</p>`;
                if (line.toUpperCase().includes("IMPROVEMENT")) return `<p class="feedback-improvement">${line}</p>`;
                if (line.trim() === "") return `<br>`;
                return `<p>${line}</p>`;
            }).join('');
        }

        // UI Helper Functions
        function setLoading(isLoading) {
            if (isLoading) {
                loading.style.display = 'block';
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = "Analyzing...";
            } else {
                loading.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = "Analyze Resume";
            }
        }

        function showAiFeedback(feedback) {
            feedbackContent.innerHTML = renderAiFeedback(feedback);
            aiFeedback.style.display = 'block';
        }

        function showMatchResult(result) {
            matchPercentage.textContent = result.matchPercentage;
            missingKeywords.textContent = result.missingKeywords.join(", ") || "None";
            matchResult.style.display = 'block';
        }

        function hideResults() {
            aiFeedback.style.display = 'none';
            matchResult.style.display = 'none';
        }

        function showSuccessText() {
            successText.style.display = 'block';
        }

        function hideSuccessText() {
            successText.style.display = 'none';
        }

        function showMessage(message, type = "info") {
            const colors = {
                success: "#d4edda",
                error: "#f8d7da", 
                warning: "#fff3cd",
                info: "#d1ecf1"
            };
            
            const textColors = {
                success: "#155724",
                error: "#721c24",
                warning: "#856404", 
                info: "#0c5460"
            };

            messageArea.innerHTML = `
                <div class="message" style="background: ${colors[type]}; color: ${textColors[type]}; border-color: ${colors[type]}">
                    ${message}
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }
    </script>
    </body>
</html>
